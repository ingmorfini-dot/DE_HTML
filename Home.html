<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard Applicazione</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="temi.css" />
  <script>
// 🔹 Cambia tema e aggiorna localStorage + combo box
function cambiaTema(nomeTema) {
  document.body.classList.remove(
    'tema-scuro',
    'tema-chiaro',
    'tema-neutro',
    'tema-verde',
    'tema-blu',
    'tema-rosso',
    'tema-viola',
    'tema-cyber',
    'tema-cartoon',
    'tema-matrix',
    'tema-morfini',
    'tema-quantico',
    'tema-nebulosa',
    'tema-ghiaccio',
    'tema-hologram'
  );

  document.body.classList.add(nomeTema);
  localStorage.setItem('tema', nomeTema);

  const selettore = document.getElementById('selettore-tema');
  if (selettore) selettore.value = nomeTema;
}


// 🔹 Carica una maschera (es. clienti.html) nella colonna sinistra
function caricaMaschera(nome) {
	if (typeof chiudiSchedaCliente === 'function') {
		chiudiSchedaCliente();
	}
  document.getElementById('ponte').value = 'home:' + nome + ':load';

  fetch(nome + '.html')
    .then(response => response.text())
    .then(html => {
      const contenitore = document.getElementById('colonna-sinistra');
      contenitore.innerHTML = html;

      const scripts = contenitore.querySelectorAll('script');
      scripts.forEach(oldScript => {
        const newScript = document.createElement('script');
        if (oldScript.src) {
          newScript.src = oldScript.src;
        } else {
          newScript.textContent = oldScript.textContent;
        }
        document.head.appendChild(newScript);
      });

      document.getElementById('ponte').value = 'home:' + nome + ':ok';
    })
    .catch(error => {
      console.error('Errore nel caricamento:', error);
    });
}

// 🔹 Utility per suggerimenti input
function impostaSuggerimenti(idCampo, arrayValori) {
  const classeAssociata = idCampo + "-datalist";
  const campi = document.querySelectorAll("." + classeAssociata);

  campi.forEach(campo => {
    if (campo.tagName !== "INPUT" || campo.type !== "text") return;

    const datalistId = campo.id + "-datalist";
    let datalist = document.getElementById(datalistId);

    if (!datalist) {
      datalist = document.createElement("datalist");
      datalist.id = datalistId;
      document.body.appendChild(datalist);
      campo.setAttribute("list", datalistId);
    }

    const esistenti = new Set(Array.from(datalist.children).map(opt => opt.value));
    arrayValori.forEach(val => {
      if (!esistenti.has(val)) {
        const option = document.createElement("option");
        option.value = val;
        datalist.appendChild(option);
      }
    });
  });
}

// 🔹 Utility per opzioni select
function impostaOpzioniSelect(idCampo, arrayValori) {
  const classeTarget = idCampo + "-select";
  const campi = document.querySelectorAll("." + classeTarget);

  campi.forEach(campo => {
    if (campo.tagName !== "SELECT") return;

    campo.innerHTML = "";

    const placeholder = document.createElement("option");
    placeholder.value = "";
    placeholder.textContent = "-- Seleziona --";
    campo.appendChild(placeholder);

    arrayValori.forEach(val => {
      const option = document.createElement("option");
      option.value = val;
      option.textContent = val;
      campo.appendChild(option);
    });
  });
}

// 🔹 Inizializzazione al caricamento
window.addEventListener('DOMContentLoaded', () => {
  // ✅ Applica il tema salvato
  const temaSalvato = localStorage.getItem('tema');
  if (temaSalvato) {
    document.body.classList.add(temaSalvato);
    const selettore = document.getElementById('selettore-tema');
    if (selettore) selettore.value = temaSalvato;
  }

  // ✅ Log ponte
  const ponte = document.getElementById('ponte');
  const inDemo = window.location.href.includes("demo");
  const log = document.getElementById('log-ponte');
  const cruscotto = document.getElementById('cruscotto-ponte');
  const toggleBtn = document.getElementById('toggle-log');
  let ultimoValore = ponte.value;

  toggleBtn.addEventListener('click', () => {
    cruscotto.classList.toggle('hidden');
  });

  setInterval(() => {
    if (ponte.value !== ultimoValore && ponte.value.trim() !== "") {
      const voce = document.createElement('div');
      voce.textContent = ponte.value;
      log.prepend(voce);
      ultimoValore = ponte.value;

      if (log.children.length > 50) {
        log.removeChild(log.lastChild);
      }
    }
  }, 200);

  // ✅ Gestione trascinamento divisore
  let isDragging = false;
  const divisore = document.getElementById('divisore');
  const contenitore = document.getElementById('contenuto');
  const sinistra = document.getElementById('colonna-sinistra');
  const destra = document.getElementById('colonna-destra');

  divisore.addEventListener('mousedown', () => {
    isDragging = true;
    document.body.style.cursor = 'col-resize';
  });

  document.addEventListener('mousemove', (e) => {
    if (!isDragging) return;
    const offset = e.clientX - contenitore.offsetLeft;
    const totalWidth = contenitore.offsetWidth;
    const minWidth = 100;

    if (offset > minWidth && offset < totalWidth - minWidth) {
      sinistra.style.flex = 'none';
      sinistra.style.width = offset + 'px';
      destra.style.flex = '1';
    }
  });

  document.addEventListener('mouseup', () => {
    if (isDragging) {
      isDragging = false;
      document.body.style.cursor = 'default';
    }
  });
});

function salvaStile() {
  const ponte = document.getElementById('ponte');
  if (ponte) ponte.value = 'home:stile:salva';
}
if (inDemo) {
  const script = document.createElement("script");
  script.src = "simulatore.js";
  script.onload = () => {
    if (typeof simulaPonte === "function") {
      const ponte = document.getElementById("ponte");
      const observer = new MutationObserver(() => {
        const comando = ponte.value;
        if (comando) {
          console.log("🧪 Ponte simulato:", comando);
          simulaPonte(comando);
        }
      });
      observer.observe(ponte, { attributes: true, attributeFilter: ["value"] });
    }
  };
  document.head.appendChild(script);
}


</script>
</head>
<body>
<header>
  <img src="Logo.svg" alt="Logo" />
  <div class="separator"></div>

  <div class="button-group">
    <button onclick="caricaMaschera('clienti')">👥 Clienti</button>
    <button onclick="caricaMaschera('fornitori')">🏢 Fornitori</button>
    <button onclick="caricaMaschera('progetti')">📁 Progetti</button>
    <button onclick="caricaMaschera('diagnosi')">🔍 Diagnosi</button>
  </div>

  <div class="button-group">
    <label for="selettore-tema">🎨 Tema:</label>
    <select id="selettore-tema" onchange="cambiaTema(this.value)">
      <option value="tema-scuro">🌑 Scuro</option>
      <option value="tema-chiaro">🌞 Chiaro</option>
      <option value="tema-neutro">🌫️ Neutro</option>
      <option value="tema-verde">🌿 Verde</option>
      <option value="tema-blu">🌊 Blu</option>
      <option value="tema-rosso">🔥 Rosso</option>
      <option value="tema-viola">🪻 Viola</option>
      <option value="tema-cyber">🧬 Cyberpunk</option>
      <option value="tema-cartoon">🎨 Cartoon</option>
      <option value="tema-matrix">🕶️ Matrix</option>
      <option value="tema-morfini">🏢 Morfini</option>
      <option value="tema-quantico">🧠 Quantico</option>
      <option value="tema-nebulosa">🌌 Nebulosa</option>
      <option value="tema-ghiaccio">🧊 Ghiaccio Tecnico</option>
      <option value="tema-hologram">🪞 Hologram</option>
    </select>
    <button onclick="salvaStile()">💾 Salva</button>
  </div>
</header>



<main>
  <div id="contenuto" class="split-view">
    <div id="colonna-sinistra" class="scroll-colonna"></div>
    <div id="divisore"></div>
    <div id="colonna-destra" class="scroll-colonna"></div>
  </div>
</main>


  <footer>
    <div class="footer-content">
      <span>&copy; 2025 M.Morfini Solutions — DE System HTML</span>
      <button id="toggle-log" class="btn-log">📋 Log</button>
    </div>
    <input type="hidden" id="ponte" value="" />
  </footer>

  <div id="cruscotto-ponte" class="cruscotto-ponte hidden">
    <h3>📋 Istruzioni inviate a VBA</h3>
    <div id="log-ponte" class="log-ponte"></div>
  </div>
</body>
</html>
